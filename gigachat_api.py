# gigachat_api.py - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –†–ê–ó–î–ï–õ–¨–ù–´–ú–ò –ó–ê–ü–†–û–°–ê–ú–ò

import requests
import json
import uuid
from datetime import datetime, timedelta
import sqlite3
import logging
import time
from typing import Optional, Dict
import hashlib

class GigaChatAPI:
    def __init__(self, db_path="dreams.db"):
        self.auth_key = "MDE5YTgyMTYtYjQzOS03YTIyLWEwNjktMzU2NTBjYzhlOGM5OjMyNGJlNTg4LTg1Y2YtNGYxMi05OTFhLTIwY2UwNzAwZWE0NQ=="
        self.scope = "GIGACHAT_API_PERS"
        self.access_token = None
        self.token_expires = None
        self.db_path = db_path
        self.cache = {}
        self.cache_ttl = 300  # 5 –º–∏–Ω—É—Ç –∫—ç—à–∞
        
        # –ù–ê–°–¢–†–û–ô–ö–ò –¢–ê–ô–ú–ê–£–¢–û–í
        self.request_timeout = 12  # —Å–µ–∫—É–Ω–¥
        self.token_timeout = 6     # —Å–µ–∫—É–Ω–¥
        
        logging.info("üöÄ –£—Å–∫–æ—Ä–µ–Ω–Ω—ã–π GigaChatAPI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
    
    def get_access_token(self):
        """–ë–´–°–¢–†–û–ï –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        if self.access_token and self.token_expires and datetime.now() < self.token_expires:
            return self.access_token
        
        url = "https://ngw.devices.sberbank.ru:9443/api/v2/oauth"
        headers = {
            "Content-Type": "application/x-www-form-urlencoded",
            "Accept": "application/json",
            "Authorization": f"Basic {self.auth_key}",
            "RqUID": str(uuid.uuid4())
        }
        data = {"scope": self.scope}
        
        try:
            start_time = time.time()
            response = requests.post(url, headers=headers, data=data, verify=False, timeout=self.token_timeout)
            logging.info(f"‚úÖ Token –ø–æ–ª—É—á–µ–Ω –∑–∞ {time.time() - start_time:.2f} —Å–µ–∫")
            
            if response.status_code == 200:
                token_data = response.json()
                self.access_token = token_data["access_token"]
                self.token_expires = datetime.now() + timedelta(minutes=25)
                return self.access_token
            else:
                logging.error(f"‚ùå –û—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞: {response.status_code}")
                return None
                
        except requests.exceptions.Timeout:
            logging.error("‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞")
            return None
        except Exception as e:
            logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: {e}")
            return None

    def get_cache_key(self, dream_text: str, analysis_type: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –∫—ç—à–∞ —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ –∞–Ω–∞–ª–∏–∑–∞"""
        text_hash = hashlib.md5(dream_text.encode()).hexdigest()
        return f"{text_hash}_{analysis_type}"

    def get_cached_interpretation(self, cache_key: str) -> Optional[str]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ –∫—ç—à–∞"""
        if cache_key in self.cache:
            cached_time, interpretation = self.cache[cache_key]
            if time.time() - cached_time < self.cache_ttl:
                logging.info("‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é")
                return interpretation
            else:
                del self.cache[cache_key]
        return None

    def interpret_dream(self, dream_text: str, user_id: int, user_name: str = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", 
                       analysis_type: str = "basic") -> str:
        """–£–°–ö–û–†–ï–ù–ù–ê–Ø –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Å–Ω–∞ —Å –†–ê–ó–î–ï–õ–¨–ù–´–ú–ò —Ç–∏–ø–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞"""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cache_key = self.get_cache_key(dream_text, analysis_type)
        cached_result = self.get_cached_interpretation(cache_key)
        
        if cached_result:
            return cached_result

        access_token = self.get_access_token()
        
        if not access_token:
            logging.warning("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—ã–π —Ñ–æ–ª–±—ç–∫")
            return self._get_fast_fallback(dream_text, analysis_type)
        
        url = "https://gigachat.devices.sberbank.ru/api/v1/chat/completions"
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {access_token}"
        }

        # –†–ê–ó–ù–´–ï –ü–†–û–ú–ü–¢–´ –î–õ–Ø –†–ê–ó–ù–´–• –¢–ò–ü–û–í –ê–ù–ê–õ–ò–ó–ê
        system_prompt = self._build_prompt_by_type(analysis_type)
        
        user_message = f"–°–æ–Ω: {dream_text}"
        
        # –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ –î–õ–Ø –°–ö–û–†–û–°–¢–ò
        data = {
            "model": "GigaChat",
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ],
            "temperature": 0.7,
            "max_tokens": 500,  # –ú–ï–ù–¨–®–ï –¢–û–ö–ï–ù–û–í = –ë–´–°–¢–†–ï–ï
            "top_p": 0.9,
            "stream": False
        }
        
        try:
            start_time = time.time()
            logging.info(f"üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ GigaChat (—Ç–∏–ø: {analysis_type})...")
            
            response = requests.post(url, headers=headers, json=data, verify=False, timeout=self.request_timeout)
            request_time = time.time() - start_time
            logging.info(f"‚úÖ GigaChat –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ {request_time:.2f} —Å–µ–∫")
            
            if response.status_code == 200:
                result = response.json()
                interpretation = result["choices"][0]["message"]["content"]
                
                interpretation = self._clean_interpretation(interpretation)
                
                # –ö–≠–®–ò–†–£–ï–ú –†–ï–ó–£–õ–¨–¢–ê–¢
                self.cache[cache_key] = (time.time(), interpretation)
                
                return interpretation
            else:
                logging.warning(f"‚ö†Ô∏è GigaChat error: {response.status_code}, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ–ª–±—ç–∫")
                return self._get_fast_fallback(dream_text, analysis_type)
            
        except requests.exceptions.Timeout:
            logging.warning("‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç GigaChat, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—ã–π —Ñ–æ–ª–±—ç–∫")
            return self._get_fast_fallback(dream_text, analysis_type)
        except Exception as e:
            logging.error(f"‚ùå –û—à–∏–±–∫–∞ GigaChat: {e}")
            return self._get_fast_fallback(dream_text, analysis_type)

    def _build_prompt_by_type(self, analysis_type: str) -> str:
        """–ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞–Ω–∞–ª–∏–∑–∞"""
        prompts = {
            "basic": """–î–∞–π –∫—Ä–∞—Ç–∫—É—é –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é —Å–Ω–∞ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). 
–§–æ—Ä–º–∞—Ç: –û—Å–Ω–æ–≤–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã ‚Üí –≠–º–æ—Ü–∏–∏ ‚Üí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏""",

            "–ø–æ–¥—Ä–æ–±–Ω–µ–µ": """–î–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–Ω–∞ (5-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π).
–°—Ç—Ä—É–∫—Ç—É—Ä–∞: 
‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏–µ
‚Ä¢ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω
‚Ä¢ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã
‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏""",

            "—ç–º–æ—Ü–∏–∏": """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω —Å–Ω–∞. –ù–µ —É–ø–æ–º–∏–Ω–∞–π —Å–∏–º–≤–æ–ª—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞: 
‚Ä¢ –ü—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∏—Ö —ç–º–æ—Ü–∏—è—Ö
‚Ä¢ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö  
‚Ä¢ –°–≤—è–∑–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è–º–∏
‚Ä¢ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)""",

            "—Å–∏–º–≤–æ–ª—ã": """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û –∫–ª—é—á–µ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã —Å–Ω–∞. –ù–µ —É–ø–æ–º–∏–Ω–∞–π —ç–º–æ—Ü–∏–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞:
‚Ä¢ –ó–Ω–∞—á–µ–Ω–∏–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤
‚Ä¢ –ê—Ä—Ö–µ—Ç–∏–ø–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–∞—Ö
‚Ä¢ –õ–∏—á–Ω–æ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ü–∏—è—Ö
‚Ä¢ –°–≤—è–∑–∏ —Å –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ–º (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)""",

            "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏": """–î–∞–π –¢–û–õ–¨–ö–û –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å–æ —Å–Ω–æ–º. –ù–µ —É–ø–æ–º–∏–Ω–∞–π —Å–∏–º–≤–æ–ª—ã –∏ —ç–º–æ—Ü–∏–∏.
–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞:
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö –¥–ª—è –æ—Å–æ–∑–Ω–∞–Ω–∏—è
‚Ä¢ –¢–µ—Ö–Ω–∏–∫–∞—Ö —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
‚Ä¢ –ü—Ä–∞–∫—Ç–∏–∫–∞—Ö –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–Ω—Å–∞–π—Ç–æ–≤
‚Ä¢ –®–∞–≥–∞—Ö –¥–ª—è –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)""",

            "–¥–∏–Ω–∞–º–∏–∫–∞": """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û –¥–∏–Ω–∞–º–∏–∫—É –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å–Ω–∞. 
–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞:
‚Ä¢ –ü–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Ç–µ–º–∞—Ö
‚Ä¢ –≠–≤–æ–ª—é—Ü–∏–∏ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–π
‚Ä¢ –ü—Ä–æ–≥—Ä–µ—Å—Å–µ –≤ –æ—Å–æ–∑–Ω–∞–Ω–∏–∏
‚Ä¢ –¢–µ–Ω–¥–µ–Ω—Ü–∏—è—Ö —Ä–∞–∑–≤–∏—Ç–∏—è (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)""",

            "–ø–∞—Ç—Ç–µ—Ä–Ω—ã": """–í—ã—è–≤–∏ –¢–û–õ–¨–ö–û –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Ç–µ–º—ã.
–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞:
‚Ä¢ –£—Å—Ç–æ–π—á–∏–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
‚Ä¢ –¶–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –æ–±—Ä–∞–∑–∞—Ö
‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã—Ö –º–æ—Ç–∏–≤–∞—Ö
‚Ä¢ –°–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—è—Ö (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)"""
        }
        
        return prompts.get(analysis_type, prompts["basic"])

    def _get_fast_fallback(self, dream_text: str, analysis_type: str) -> str:
        """–°–£–ü–ï–†–ë–´–°–¢–†–´–ô —Ñ–æ–ª–±—ç–∫ —Å –†–ê–ó–ù–´–ú–ò –æ—Ç–≤–µ—Ç–∞–º–∏"""
        fallbacks = {
            "basic": f"""üîÆ **–ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø –°–ù–ê**

üí≠ **–°–æ–Ω:** "{dream_text}"

üé≠ **–û—Å–Ω–æ–≤–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã:** –°–æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–∂–Ω—ã–µ –æ–±—Ä–∞–∑—ã –¥–ª—è —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞.
üí´ **–≠–º–æ—Ü–∏–∏:** –ü—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∏–µ —ç–º–æ—Ü–∏–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è.
üåü **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Å–Ω—ã –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.""",

            "–ø–æ–¥—Ä–æ–±–Ω–µ–µ": f"""üîç **–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –°–ù–ê**

üí≠ **–°–æ–Ω:** "{dream_text}"

üé≠ **–ö–ª—é—á–µ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã:** –û–±—Ä–∞–∑—ã —Å–Ω–∞ –æ—Ç—Ä–∞–∂–∞—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
üí´ **–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω:** –≠–º–æ—Ü–∏–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –Ω–µ–æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.
üîÆ **–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã:** –°–æ–Ω –º–æ–∂–µ—Ç –æ—Ç—Ä–∞–∂–∞—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.
üåü **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ç–µ–º—ã.""",

            "—ç–º–æ—Ü–∏–∏": f"""üí≠ **–≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó**

üí≠ **–°–æ–Ω:** "{dream_text}"

üí´ **–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω:** –°–æ–Ω –æ—Ç—Ä–∞–∂–∞–µ—Ç –≤–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –ü—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∏–µ —ç–º–æ—Ü–∏–∏ –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –Ω–µ–æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏.

üòä **–î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ —á—É–≤—Å—Ç–≤–∞:** –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —ç–º–æ—Ü–∏–π –≤–æ —Å–Ω–µ.
üîÑ **–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:** –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —á—É–≤—Å—Ç–≤–∞ –º–æ–≥—É—Ç —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ –≤–∞–∂–Ω—ã—Ö —Ç–µ–º–∞—Ö.""",

            "—Å–∏–º–≤–æ–ª—ã": f"""üîç **–ê–ù–ê–õ–ò–ó –°–ò–ú–í–û–õ–û–í**

üí≠ **–°–æ–Ω:** "{dream_text}"

üé≠ **–ö–ª—é—á–µ–≤—ã–µ –æ–±—Ä–∞–∑—ã:** –û—Å–Ω–æ–≤–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã —Å–Ω–∞ –Ω–µ—Å—É—Ç –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–º –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–∏. –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–æ–∂–µ—Ç –æ—Ç—Ä–∞–∂–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –æ–ø—ã—Ç–∞.

üîÆ **–ê—Ä—Ö–µ—Ç–∏–ø–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:** –°–∏–º–≤–æ–ª—ã —á–∞—Å—Ç–æ —Å–≤—è–∑–∞–Ω—ã —Å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º–∏ –æ–±—Ä–∞–∑–∞–º–∏.
üí´ **–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–µ –ø—Ä–æ–µ–∫—Ü–∏–∏:** –û–±—Ä–∞–∑—ã –º–æ–≥—É—Ç –æ—Ç—Ä–∞–∂–∞—Ç—å –≤–∞—à–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –∂–µ–ª–∞–Ω–∏—è.""",

            "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏": f"""üåü **–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò**

üí≠ **–°–æ–Ω:** "{dream_text}"

üå± **–î–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–Ω–æ–º:**
‚Ä¢ –í–µ–¥–∏—Ç–µ –¥–Ω–µ–≤–Ω–∏–∫ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
‚Ä¢ –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫–ª—é—á–µ–≤—ã–º–∏ –æ–±—Ä–∞–∑–∞–º–∏
‚Ä¢ –ò—Å—Å–ª–µ–¥—É–π—Ç–µ —Å–≤—è–∑–∏ —Å —Ç–µ–∫—É—â–∏–º–∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º–∏ —Å–∏—Ç—É–∞—Ü–∏—è–º–∏
‚Ä¢ –û–±—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ç–µ–º—ã –∏ —Å–∏–º–≤–æ–ª—ã

üìö **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:** –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Å–Ω–∞–º–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏–∫–∏.""",

            "–¥–∏–Ω–∞–º–∏–∫–∞": f"""üåô **–î–ò–ù–ê–ú–ò–ö–ê –°–ù–û–í–ò–î–ï–ù–ò–ô**

üí≠ **–°–æ–Ω:** "{dream_text}"

üìä **–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–≤–∏—Ç–∏—è:** 
–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç–≤–æ–ª—é—Ü–∏—é —Ç–µ–º –∏ –æ–±—Ä–∞–∑–æ–≤ –≤ –≤–∞—à–∏—Ö —Å–Ω–∞—Ö. –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–∏ –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —É—Å—Ç–æ–π—á–∏–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏–ª–∏ –Ω–µ—Ä–µ—à–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.

üîÑ **–¢–µ–Ω–¥–µ–Ω—Ü–∏–∏:** –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–µ —Å–Ω–æ–≤.
üéØ **–ü—Ä–æ–≥—Ä–µ—Å—Å:** –†–µ–≥—É–ª—è—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–º–æ–∂–µ—Ç –≤—ã—è–≤–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç.""",

            "–ø–∞—Ç—Ç–µ—Ä–Ω—ã": f"""üéØ **–ê–ù–ê–õ–ò–ó –ü–ê–¢–¢–ï–†–ù–û–í**

üí≠ **–°–æ–Ω:** "{dream_text}"

üîç **–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ç–µ–º—ã:**
–í—ã—è–≤–ª–µ–Ω–∏–µ —É—Å—Ç–æ–π—á–∏–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏—è—Ö –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å –≥–ª—É–±–∏–Ω–Ω—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –º–æ—Ç–∏–≤—ã.

üìà **–ó–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏:** –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –æ–±—Ä–∞–∑—ã —á–∞—Å—Ç–æ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –≤–∞–∂–Ω—ã–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —Ç–µ–º—ã.
üí° **–ò–Ω—Å–∞–π—Ç—ã:** –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –º–æ–∂–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –ª–∏—á–Ω–æ—Å—Ç–∏."""
        }
        
        return fallbacks.get(analysis_type, fallbacks["basic"])

    def _clean_interpretation(self, interpretation: str) -> str:
        """–ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞"""
        replacements = {
            "GigaChat": "–ò–ò –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä",
            "gigachat": "–ò–ò –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä",
        }
        
        for old, new in replacements.items():
            interpretation = interpretation.replace(old, new)
        
        return interpretation

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–æ–π —Ç–æ–∫–µ–Ω–∞
gigachat = GigaChatAPI()